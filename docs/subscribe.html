<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Subscribe — DC Council Weekly Digest</title>
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; max-width: 640px; margin: 40px auto; padding: 0 16px; }
      input[type="email"], textarea { width: 100%; padding: 12px; font-size: 16px; margin: 10px 0; }
      button { padding: 12px 16px; font-size: 16px; cursor: pointer; }
      .topics { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; margin: 10px 0 6px; }
      .topic { display: flex; align-items: center; gap: 8px; }
      .hint { color: #555; font-size: 13px; margin-top: 4px; }
      .section-gap { margin-top: 12px; }
      .msg { margin-top: 12px; white-space: pre-wrap; }
      iframe { display: none; }
    </style>
  </head>
  <body>
    <h1>DC Council Weekly Digest</h1>
    <p>
      This project is developed by Prof. Michael A. Bailey and his team at McCourt School of Public Policy, 
      Georgetown University. The goal is to make local government activity easier to follow by automatically 
      collecting DC Council hearings, agendas, and related news, then summarizing the most important developments 
      each week. We want this digest to be accurate, readable, and useful for residents, advocates, and policymakers.
      If you have any suggestions or feedback, please direct them to gz163@georgetown.edu. Thanks!
    </p>
    <p>Enter your email to subscribe.</p>
    <p class="hint">Already subscribed? You can update your preferences here anytime.</p>

    <form id="form" method="POST" target="hidden_iframe">
      <input id="email" name="email" type="email" placeholder="you@example.com" required />

      <p style="margin: 12px 0 6px;">What topics are you most interested in?</p>
      <div class="topics" id="topics">
        <label class="topic"><input type="checkbox" value="Budget" /> Budget</label>
        <label class="topic"><input type="checkbox" value="Public safety" /> Public safety</label>
        <label class="topic"><input type="checkbox" value="Housing" /> Housing</label>
        <label class="topic"><input type="checkbox" value="Transportation" /> Transportation</label>
        <label class="topic"><input type="checkbox" value="Education" /> Education</label>
        <label class="topic"><input type="checkbox" value="Health" /> Health</label>
      </div>
      <input id="topicsInput" name="topics" type="hidden" />

      <label for="interests" class="section-gap">Anything else you care about?</label>
      <textarea id="interests" name="interests" rows="3" placeholder="e.g., committee hearings, Pepco oversight, neighborhood projects"></textarea>
      <div class="hint">We use this to tailor the weekly summary for you.</div>
      <button id="btn" type="submit" class="section-gap">Subscribe</button>
    </form>

    <div id="msg" class="msg"></div>
    <iframe name="hidden_iframe" id="hidden_iframe"></iframe>

    <script>
      // IMPORTANT: use your /exec URL
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby2ZqprwlWgRr2mVNaVkkuuQWYbnozHJKeW7jLf8nheMQc8rGOdsEwDRxEwvC4PPRkU/exec";

      const formEl = document.getElementById("form");
      const msgEl = document.getElementById("msg");
      const btnEl = document.getElementById("btn");
      const iframeEl = document.getElementById("hidden_iframe");
      const topicsEl = document.getElementById("topics");
      const topicsInputEl = document.getElementById("topicsInput");
      let isSubmitting = false;
      let fallbackTimer = null;

      function setMsg(text) { msgEl.textContent = text; }

      // This will hit doPost(e) with e.parameter.path === "subscribe" and e.parameter.email set
      formEl.action = `${WEB_APP_URL}?path=subscribe`;

      function finishSubmit(message) {
        setMsg(message);
        btnEl.disabled = false;
        isSubmitting = false;
        if (fallbackTimer) {
          window.clearTimeout(fallbackTimer);
          fallbackTimer = null;
        }
      }

      iframeEl.addEventListener("load", () => {
        if (!isSubmitting) return;
        finishSubmit("Submitted ✅");
      });

      formEl.addEventListener("submit", (e) => {
        e.preventDefault();
        setMsg("Submitting...");
        btnEl.disabled = true;
        isSubmitting = true;

        fallbackTimer = window.setTimeout(() => {
          finishSubmit("Submitted ✅");
        }, 4000);

        try {
          const selectedTopics = Array.from(
            topicsEl.querySelectorAll("input[type='checkbox']:checked")
          ).map((el) => el.value);
          topicsInputEl.value = selectedTopics.join(", ");

          // Use fetch with no-cors so the UI can complete without waiting on iframe behavior.
          const formData = new FormData(formEl);
          const submitUrl = `${WEB_APP_URL}?path=subscribe`;

          fetch(submitUrl, {
            method: "POST",
            mode: "no-cors",
            body: formData,
          })
            .then(() => {
              finishSubmit("Submitted ✅");
            })
            .catch(() => {
              finishSubmit("Submission failed. Please try again or contact gz163@georgetown.edu for assistance.");
            });
        } catch (err) {
          finishSubmit("Submission failed. Please try again or contact gz163@georgetown.edu for assistance.");
        }
      });
    </script>
  </body>
</html>